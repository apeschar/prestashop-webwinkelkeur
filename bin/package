#!/bin/bash

set -euo pipefail
cd "$(dirname "$0")/.."

version="$(git describe --tags --match 'v*' | sed 's/^v//')"
out="$PWD/dist/prestashop-webwinkelkeur-$version.zip"

echo "Packaging version $version..." >&2

mkdir -p dist

tmp="$(mktemp -d)"
cleanup() { rm -rf "$tmp"; }
trap cleanup EXIT

git archive master -- webwinkelkeur | tar xC "$tmp"

cd "$tmp"
perl -p -i -e 's~\$VERSION\$~'"$version"'~g' webwinkelkeur/webwinkelkeur.php

rm -f "$out"
zip -r9 "$out" webwinkelkeur
